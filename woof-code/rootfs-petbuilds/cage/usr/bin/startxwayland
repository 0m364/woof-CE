#!/bin/sh

# heavily inspired by https://source.mnt.re/reform/reform-system-image/-/blob/d9ed139c4fb7e4443c0fc1d226021a2671e28da8/reform2-imx8mq/template-skel/bin/reform-windowmaker

# this configuration file is modified by xkbconfigmanager
if [ -f ~/.Xkbrc ]; then
	. ~/.Xkbrc
	[ -n "$XKB_DEFAULT_LAYOUT" ] && export XKB_DEFAULT_LAYOUT
	[ -n "$XKB_DEFAULT_MODEL" ] && export XKB_DEFAULT_MODEL
	[ -n "$XKB_DEFAULT_OPTIONS" ] && export XKB_DEFAULT_OPTIONS
else
	cat << EOF > ~/.Xkbrc
XKB_DEFAULT_LAYOUT=
XKB_DEFAULT_MODEL=
XKB_DEFAULT_OPTIONS=
EOF
	unset XKB_DEFAULT_LAYOUT
	unset XKB_DEFAULT_MODEL
	unset XKB_DEFAULT_OPTIONS
fi

DISPLAY=:1
XAUTHORITY=~/.Xauthority

auth=`mktemp`
echo "add $DISPLAY . `mcookie`" | xauth -q -f "$XAUTHORITY"
if [ "`id -u`" -eq 0 ]; then
	cp -f $XAUTHORITY /home/spot/.Xauthority
	chown spot:spot /home/spot/.Xauthority
fi

cage -ds -- Xwayland :1 -auth "$XAUTHORITY" &

export DISPLAY
export XAUTHORITY

MAX=20
CT=0
while ! xdpyinfo >/dev/null 2>&1; do
    sleep 0.50s
    CT=$(( CT + 1 ))
    if [ "$CT" -ge "$MAX" ]; then
        echo "FATAL: $0: Gave up waiting for X server $DISPLAY"
        exit 11
    fi
done

export WAYLAND_DISPLAY=null
export GDK_BACKEND=x11
unset SDL_VIDEODRIVER

exec "$1"